{% extends 'mainapp/base.html' %}

{% block body_block %}
<style>
    .chat-interface {
        display: flex;
        height: 100vh;
    }
    .chat-list {
        width: 30%;
        background-color: #2C3E50;
        overflow-y: auto;
        padding: 10px;
        color: white;
    }
    .chat-display {
        width: 70%;
        background-color: #ECF0F1;
        overflow-y: auto;
        padding-bottom: 10px;
    }
    .chat-list-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #34495E;
    }
    .chat-list-item:hover {
        background-color: #34495E;
    }
    .chat-header {
        background-color: #3498DB;
        color: white;
        padding: 10px;
    }
    .chat-messages {
        height: calc(100% - 120px);
        overflow-y: auto;
        padding: 15px 10px;
    }
    .send-message-form {
        background-color: transparent;
        position: fixed;
        bottom: 0;
        width: calc(70% - 20px);
        display: flex;
        align-items: center;
        padding: 0 10px;
        box-sizing: border-box;
    }
    .send-message-input {
        flex-grow: 1;
        padding: 12px 20px;
        border-radius: 22px;
        border: none;
        margin-right: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .send-message-button {
        padding: 12px 20px;
        background-color: #007bff;
        color: white;
        border-radius: 22px;
        border: none;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .message {
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
        padding: 10px 20px;
        border-radius: 18px;
        width: 15%;
        max-width: 60%;
        transition: opacity 0.5s, transform 0.5s;
    }
    .message-author {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 12px;
        align-self: flex-start;
        color: black;
        margin-top: 5px;
    }
    .message-body {
    display: flex;
    flex-direction: column;
    }
    .message-enter {
    opacity: 0;
    transform: translateY(20px);
    }
    .message-enter-active {
    opacity: 1;
    transform: translateY(0);
    }
    .message.theirs {
        align-self: flex-start;
        background-color: #e5e5ea;
        margin-right: auto;
        padding: 10px 20px 0;
        border-radius: 18px;
    }

    .message.mine {
        align-self: flex-end;
        background-color: #0084ff;
        color: white;
        margin-left: auto;
        padding: 10px 20px 0;
        border-radius: 18px;
    }
    .message-timestamp {
        align-self: flex-end;
        margin-left: 10px;
        font-size: 0.75rem;
        color: black;
        margin-bottom: 5px;
    }
</style>

<div class="chat-interface">
    <aside class="chat-list">
        {% for post in posts %}
        <div class="chat-list-item" onclick="window.location.href='{% url 'view_chat' post_id=post.pk %}'">
            {{ post.title }}
        </div>
        {% endfor %}
    </aside>

    <section class="chat-display" id="chat-display">
        <div class="chat-header">
            <h2>{{ current_post.title }}</h2>
            <p class="post-content text-black-700">{{ post.content|truncatewords:30 }}</p>
        </div>
        <div class="chat-messages" id="chat-messages">
            {% for message in messages %}
            <div class="message {% if message.author.username == request.user.username %}mine{% else %}theirs{% endif %}">
                <div class="message-author">{{ message.author.username }}</div>
                <div class="message-content">{{ message.content }}</div>
                <div class="message-timestamp">{{ message.timestamp|date:"H:i" }}</div>
            </div>
            {% empty %}
            <p>No messages yet.</p>
            {% endfor %}
        </div>
        {% if user_can_post %}
        <div class="send-message-container">
        <form action="{% url 'send_message' %}" method="post" class="send-message-form mb-5">
          {% csrf_token %}  <input type="hidden" name="chat_id" value="{{ chat.pk }}" />
          <input type="text" name="message" placeholder="Type your message here..." class="send-message-input" autocomplete="off" required />
          <button type="submit" class="send-message-button">Send</button>
        </form>
        </div>
    {% else %}
        <p>You need to <a href="{% url 'login' %}">login</a> to send messages.</p>
        {% endif %}
    </section>
</div>

<script>
document.querySelector('.send-message-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const messageInput = this.querySelector('input[name="message"]');
    const chatIdInput = this.querySelector('input[name="chat_id"]');
    const messageValue = messageInput.value;

    if (!messageValue.trim()) {
        return;
    }

    fetch("{% url 'send_message' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': this.querySelector('input[name="csrfmiddlewaretoken"]').value,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
            'chat_id': chatIdInput.value,
            'message': messageValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const chatMessagesDiv = document.getElementById('chat-messages');

            const newMessageDiv = document.createElement('div');
            newMessageDiv.classList.add('message', data.author === '{{ request.user.username }}' ? 'mine' : 'theirs', 'message-enter');
            newMessageDiv.innerHTML = `
                <div class="message-author">${data.author}</div>
                <div class="message-body">
                    <div class="message-content">${data.content}</div>
                    <div class="message-timestamp">${data.timestamp}</div>
                </div>`;
            chatMessagesDiv.appendChild(newMessageDiv);

            messageInput.value = '';

            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;

            setTimeout(() => {
                newMessageDiv.classList.add('message-enter-active');
            }, 10);
        } else {
            console.error('Failed to send message:', data);
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
    });
});

</script>

{% endblock %}